var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Canvas=function(){function t(t){if(void 0===t&&(t=null),null==t&&(t=document.createElement("CANVAS")),this.element=t,!this.element||!this.element.getContext)throw new Error("Le canvas n'est pas pris en charge par votre navigateur");if(this.context=this.element.getContext("2d"),!this.context)throw new Error("Le canvas n'est pas pris en charge par votre navigateur");return this}return t.prototype.getContext=function(){return this.context},t.prototype.getElement=function(){return this.element},t.prototype.setSize=function(t,e){return this.element.width=t,this.element.height=e,this},t.prototype.clear=function(){return this.context.clearRect(0,0,this.element.width,this.element.height),this},t}(),Directions;!function(t){t[t.Left=0]="Left",t[t.Right=1]="Right",t[t.Up=2]="Up",t[t.Down=3]="Down"}(Directions||(Directions={}));var Modes;!function(t){t[t.Chase=0]="Chase",t[t.Scatter=1]="Scatter",t[t.Frightened=2]="Frightened",t[t.OutFromHome=3]="OutFromHome",t[t.GoingHome=4]="GoingHome"}(Modes||(Modes={}));var PacDot=function(){function t(){this.scoreValue=t.SCORE_VALUE}return t.prototype.getScoreValue=function(){return this.scoreValue},t.SCORE_VALUE=10,t}(),PowerPellet=function(t){function e(){t.apply(this,arguments),this.scoreValue=e.SCORE_VALUE}return __extends(e,t),e.SCORE_VALUE=50,e}(PacDot),Fruit=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.WIDTH=20,e}(PacDot),Cherry=function(t){function e(){t.apply(this,arguments),this.scoreValue=e.SCORE_VALUE}return __extends(e,t),e.SCORE_VALUE=100,e}(Fruit),Strawberry=function(t){function e(){t.apply(this,arguments),this.scoreValue=e.SCORE_VALUE}return __extends(e,t),e.SCORE_VALUE=300,e}(Fruit),Orange=function(t){function e(){t.apply(this,arguments),this.scoreValue=e.SCORE_VALUE}return __extends(e,t),e.SCORE_VALUE=500,e}(Fruit),Apple=function(t){function e(){t.apply(this,arguments),this.scoreValue=e.SCORE_VALUE}return __extends(e,t),e.SCORE_VALUE=700,e}(Fruit),Melon=function(t){function e(){t.apply(this,arguments),this.scoreValue=e.SCORE_VALUE}return __extends(e,t),e.SCORE_VALUE=1e3,e}(Fruit),Galaxian=function(t){function e(){t.apply(this,arguments),this.scoreValue=e.SCORE_VALUE}return __extends(e,t),e.SCORE_VALUE=2e3,e}(Fruit),Bell=function(t){function e(){t.apply(this,arguments),this.scoreValue=e.SCORE_VALUE}return __extends(e,t),e.SCORE_VALUE=3e3,e}(Fruit),Key=function(t){function e(){t.apply(this,arguments),this.scoreValue=e.SCORE_VALUE}return __extends(e,t),e.SCORE_VALUE=5e3,e}(Fruit),FruitsManager=function(){function t(){}return t.prototype.init=function(){return this.hasFruit=!1,this.frames=0,this},t.prototype.onRequestAnimFrame=function(){this.frames++;+new Date;return!this.hasFruit&&this.frames>t.APPEARANCE_INTEVERVAL?this.newFruit():this.hasFruit&&this.frames>t.APPEARANCE_DURATION&&this.removeFruit(),this},t.prototype.newFruit=function(){this.frames=0,this.hasFruit=!0;var t,e=1,i=e+Key.SCORE_VALUE/Bell.SCORE_VALUE,n=i+Key.SCORE_VALUE/Galaxian.SCORE_VALUE,o=n+Key.SCORE_VALUE/Melon.SCORE_VALUE,s=o+Key.SCORE_VALUE/Apple.SCORE_VALUE,r=s+Key.SCORE_VALUE/Orange.SCORE_VALUE,a=r+Key.SCORE_VALUE/Strawberry.SCORE_VALUE,h=a+Key.SCORE_VALUE/Cherry.SCORE_VALUE,c=Math.round(Math.random()*(h-e)+e);t=c<=e?new Key:c<=i?new Bell:c<=n?new Galaxian:c<=o?new Melon:c<=s?new Apple:c<=r?new Orange:c<=a?new Strawberry:new Cherry;var l=new CustomEvent("NewFruit",{detail:t});return Jeu.ELEMENT.dispatchEvent(l),this},t.prototype.removeFruit=function(){this.init();var t=new CustomEvent("RemoveFruit");return Jeu.ELEMENT.dispatchEvent(t),this},t.APPEARANCE_INTEVERVAL=1800,t.APPEARANCE_DURATION=600,t}(),Functions=function(){function t(){}return t.shuffle=function(t){for(var e,i,n=t.length;n;n--)e=Math.floor(Math.random()*n),i=t[n-1],t[n-1]=t[e],t[e]=i},t}(),Ghost=function(){function t(){this.frightenedColor="#2121ff",this.stepPx=t.NORMAL,this.stepNumber=10,this.currentStep=0}return t.prototype.setCollideFunction=function(t){return this.checkCollision=t,this},t.prototype.init=function(){return this.canvas=new Canvas,this.canvas.setSize(t.SIZE.w,t.SIZE.h),this.coordinates=JSON.parse(JSON.stringify(this.startCoordinates)),this.draw(),this.alternativeMode=null,this.direction=null,this.outFromHome=!1,this.isFlashing=!1,this.stepPx=t.NORMAL,this instanceof Blinky&&(this.direction=Directions.Right,this.outFromHome=!0),this},t.prototype.draw=function(){this.canvas.clear();var e=this.canvas.getContext();if(e.globalCompositeOperation="source-over",e.beginPath(),this.alternativeMode!=Modes.GoingHome){e.arc(t.SIZE.w/2,t.SIZE.h/2,t.SIZE.w/2,0,2*Math.PI,!1),e.rect(0,t.SIZE.h/2,t.SIZE.w,t.SIZE.h/2);var i=this.alternativeMode==Modes.Frightened?this.frightenedColor:this.color;if(this.isFlashing&&this.alternativeMode==Modes.Frightened){var n=new Date,o=n.getMilliseconds();i=o>250&&o<500||o>750?"#ffffff":i}e.fillStyle=i,e.fill(),e.closePath()}var s=0,r=0;switch(this.outFromHome||this.alternativeMode==Modes.OutFromHome||this.getDirectionBasedOnTime(),this.direction){case Directions.Left:s=-2;break;case Directions.Right:s=2;break;case Directions.Up:r=-2;break;case Directions.Down:r=2}e.beginPath(),this.alternativeMode==Modes.Frightened?(e.arc(t.SIZE.w/2-4,t.SIZE.h/2-2,2,0,2*Math.PI,!1),e.arc(t.SIZE.w/2+4,t.SIZE.h/2-2,2,0,2*Math.PI,!1)):(e.ellipse(t.SIZE.w/2-5+s,t.SIZE.h/2+r,3,4,0,2*Math.PI,!1),e.ellipse(t.SIZE.w/2+5+s,t.SIZE.h/2+r,3,4,0,2*Math.PI,!1)),e.fillStyle="white",e.fill(),e.closePath(),this.alternativeMode!=Modes.Frightened?(e.beginPath(),e.ellipse(t.SIZE.w/2-5+2*s,t.SIZE.h/2+2*r,1,2,0,2*Math.PI,!1),e.ellipse(t.SIZE.w/2+5+2*s,t.SIZE.h/2+2*r,1,2,0,2*Math.PI,!1),e.fillStyle="black",e.fill(),e.closePath()):(e.beginPath(),e.moveTo(6,t.SIZE.h/2+6),e.lineTo(8,t.SIZE.h/2+4),e.lineTo(10,t.SIZE.h/2+6),e.lineTo(12,t.SIZE.h/2+4),e.lineTo(14,t.SIZE.h/2+6),e.lineTo(16,t.SIZE.h/2+4),e.lineTo(18,t.SIZE.h/2+6),e.strokeStyle="white",e.stroke(),e.closePath()),e.globalCompositeOperation="destination-out";for(var a=this.currentStep>=this.stepNumber/2?3:4,h=t.SIZE.w/a,c=3,l=0;l<a;++l)e.beginPath(),e.moveTo(l*t.SIZE.w/a,t.SIZE.h),e.lineTo(l*t.SIZE.w/a+h/2,t.SIZE.h-c),e.lineTo(l*t.SIZE.w/a+h,t.SIZE.h),e.closePath(),e.fill();return this},t.prototype.findBestPath=function(t){var e={x:this.coordinates.x/Tile.TILE_WIDTH,y:this.coordinates.y/Tile.TILE_WIDTH},i=new PathFinder;i.findPath(e,t,this.checkCollision.bind(this),this.hasToGoBackwards.bind(this));var n=this.direction,o=i.getNextTile();return null!=o&&(e.x==o.x+1&&(n=Directions.Left),e.x==o.x-1&&(n=Directions.Right),e.y==o.y+1&&(n=Directions.Up),e.y==o.y-1&&(n=Directions.Down)),n},t.prototype.hasToGoBackwards=function(t,e){return t.x==e.x+1?this.direction==Directions.Right:t.x==e.x-1?this.direction==Directions.Left:t.y==e.y+1?this.direction==Directions.Down:t.y!=e.y-1||this.direction==Directions.Up},t.prototype.setX=function(t){return this.coordinates.x=t,this},t.prototype.move=function(e,i){if(void 0===i&&(i=null),!this.outFromHome&&this.alternativeMode!=Modes.OutFromHome)return this;var n=this.alternativeMode||this.mode;if(this.coordinates.x%Tile.TILE_WIDTH==0&&this.coordinates.y%Tile.TILE_WIDTH==0)switch(n){case Modes.Scatter:this.direction=this.findBestPath(this.cornerCoordinates);break;case Modes.Chase:var o=this.targetTile(e,i);this.direction=this.findBestPath(o);break;case Modes.Frightened:var o,s=TileFunctions.getTileCoordinates({x:this.coordinates.x+Tile.TILE_WIDTH/2,y:this.coordinates.y+Tile.TILE_WIDTH/2}),r=TileFunctions.getAdjacentTiles(s);Functions.shuffle(r);for(var a=0;a<r.length;++a){var h=this.checkCollision(r[a].x,r[a].y);if(!h&&!this.hasToGoBackwards(s,r[a])){o=r[a];break}}this.direction=this.findBestPath(o);break;case Modes.OutFromHome:var s={x:this.coordinates.x/Tile.TILE_WIDTH,y:this.coordinates.y/Tile.TILE_WIDTH};if(7==s.x&&9==s.y)this.direction=Directions.Up;else if(7==s.x&&8==s.y){var c=new CustomEvent("OutFromHome",{detail:this});Jeu.ELEMENT.dispatchEvent(c),this.stepPx=t.NORMAL,this.outFromHome=!0,this.alternativeMode=null,this.direction=Directions.Left}else 6==s.x?this.direction=Directions.Right:8==s.x&&(this.direction=Directions.Left);break;case Modes.GoingHome:var s={x:this.coordinates.x/Tile.TILE_WIDTH,y:this.coordinates.y/Tile.TILE_WIDTH};this.direction=this.findBestPath({x:7,y:8}),7==s.x&&8==s.y&&(this.direction=Directions.Down),7==s.x&&9==s.y&&(this.direction=Directions.Up,this.changeAlternativeMode(null),this.getOutFromHome())}switch(this.direction){case Directions.Left:this.coordinates.x-=this.stepPx;break;case Directions.Right:this.coordinates.x+=this.stepPx;break;case Directions.Up:this.coordinates.y-=this.stepPx;break;case Directions.Down:this.coordinates.y+=this.stepPx}return this.checkEatOrEaten(e),this},t.prototype.animate=function(){return this.currentStep++,this.currentStep%this.stepNumber==0&&(this.currentStep=0),this.draw(),this},t.prototype.getOutFromHome=function(){return this.alternativeMode=Modes.OutFromHome,this.stepPx=t.OUT_FROM_HOME,this},t.prototype.changeMode=function(t){if(this.mode=t,this.mode==Modes.Scatter)switch(this.direction){case Directions.Left:this.direction=Directions.Right;break;case Directions.Right:default:this.direction=Directions.Left;break;case Directions.Up:this.direction=Directions.Down;break;case Directions.Down:this.direction=Directions.Up}return this},t.prototype.changeAlternativeMode=function(e){return null==this.alternativeMode||e==Modes.GoingHome?(e==Modes.Frightened&&this.outFromHome||e!=Modes.Frightened)&&(this.alternativeMode=e,e==Modes.Frightened?this.stepPx=t.FRIGHTENED:e==Modes.GoingHome&&(this.stepPx=t.GOING_HOME)):this.alternativeMode==Modes.Frightened&&null==e&&(this.alternativeMode=e,this.stepPx=t.NORMAL,this.isFlashing=!1),this.checkCoordsIntegrity(),this},t.prototype.checkCoordsIntegrity=function(){var e=this.alternativeMode==Modes.GoingHome?t.GOING_HOME:t.NORMAL;switch(this.direction){case Directions.Left:case Directions.Right:default:this.coordinates.x-=this.coordinates.x%e;break;case Directions.Up:case Directions.Down:this.coordinates.y-=this.coordinates.y%e}return this},t.prototype.getCoordinates=function(){return this.coordinates},t.prototype.getCanvas=function(){return this.canvas},t.prototype.getCanvasElem=function(){return this.canvas.getElement()},t.prototype.slow=function(){return this.alternativeMode!=Modes.GoingHome&&(this.stepPx=t.FRIGHTENED),this},t.prototype.speedUp=function(){return this.alternativeMode!=Modes.Frightened&&this.alternativeMode!=Modes.GoingHome&&(this.stepPx=t.NORMAL),this},t.prototype.checkEatOrEaten=function(t){var e={x:this.coordinates.x+Tile.TILE_WIDTH/2,y:this.coordinates.y+Tile.TILE_WIDTH/2};if(Math.abs(t.x-e.x)<10&&Math.abs(t.y-e.y)<10){if(this.alternativeMode!=Modes.GoingHome){var i=this.alternativeMode==Modes.Frightened?"GhostEaten":"PacmanEaten",n=new Event(i);Jeu.ELEMENT.dispatchEvent(n)}this.alternativeMode==Modes.Frightened&&this.changeAlternativeMode(Modes.GoingHome)}return this},t.prototype.flash=function(t){return this.isFlashing=t,this},t.prototype.getDirectionBasedOnTime=function(){var t=[Directions.Left,Directions.Right,Directions.Up,Directions.Down],e=new Date,i=Math.floor(Math.random()*t.length),n=Math.floor(1e3*Math.random());return e.getMilliseconds()>=n&&e.getMilliseconds()<=n+10&&(this.direction=t[i]),this},t.SIZE={w:24,h:24},t.OUT_FROM_HOME=1,t.NORMAL=2,t.FRIGHTENED=1,t.GOING_HOME=4,t}(),Pinky=function(t){function e(){t.call(this),this.mode=null,this.startCoordinates={x:7*Tile.TILE_WIDTH,y:9*Tile.TILE_WIDTH},this.cornerCoordinates={x:0,y:0},this.color="#fdc3d4"}return __extends(e,t),e.prototype.targetTile=function(t){var e=TileFunctions.getTileCoordinates(t);switch(t.direction){case Directions.Left:e.x=Math.max(0,e.x-4);break;case Directions.Right:e.x=Math.min(14,e.x+4);break;case Directions.Up:e.y=Math.max(0,e.y-4);break;case Directions.Down:e.y=Math.min(19,e.y+4)}return e},e}(Ghost),Blinky=function(t){function e(){t.call(this),this.mode=null,this.startCoordinates={x:7*Tile.TILE_WIDTH,y:8*Tile.TILE_WIDTH},this.cornerCoordinates={x:14,y:0},this.color="#fd3b11"}return __extends(e,t),e.prototype.targetTile=function(t){return TileFunctions.getTileCoordinates(t)},e}(Ghost),Inky=function(t){function e(){t.call(this),this.mode=null,this.startCoordinates={x:6*Tile.TILE_WIDTH,y:9*Tile.TILE_WIDTH},this.cornerCoordinates={x:14,y:19},this.color="#49dfca"}return __extends(e,t),e.prototype.targetTile=function(t,e){var i=TileFunctions.getTileCoordinates({x:e.x+Tile.TILE_WIDTH/2,y:e.y+Tile.TILE_WIDTH/2}),n=TileFunctions.getTileCoordinates(t);switch(t.direction){case Directions.Left:n.x=Math.max(0,n.x-2);break;case Directions.Right:n.x=Math.min(14,n.x+2);break;case Directions.Up:n.y=Math.max(0,n.y-2);break;case Directions.Down:n.y=Math.min(19,n.y+2)}var o={x:n.x-i.x,y:n.y-i.y},s={x:o.x+n.x,y:o.y+n.y};return s.x=Math.max(0,s.x),s.x=Math.min(14,s.x),s.y=Math.max(0,s.y),s.y=Math.min(19,s.y),s},e}(Ghost),Clyde=function(t){function e(){t.call(this),this.mode=null,this.startCoordinates={x:8*Tile.TILE_WIDTH,y:9*Tile.TILE_WIDTH},this.cornerCoordinates={x:0,y:19},this.color="#ffbf57"}return __extends(e,t),e.prototype.targetTile=function(t){var e=TileFunctions.getTileCoordinates(t),i=TileFunctions.getTileCoordinates({x:this.coordinates.x+Tile.TILE_WIDTH/2,y:this.coordinates.y+Tile.TILE_WIDTH/2}),n=new PathFinder;n.findPath(i,e,this.checkCollision.bind(this),this.hasToGoBackwards.bind(this));var o=n.getDistance();return o>8?e:this.cornerCoordinates},e}(Ghost),GhostsManager=function(){function t(){this.chaseInterval=1200,this.scatterInterval=420,this.frightenedInterval=420,this.pinky=new Pinky,this.blinky=new Blinky,this.inky=new Inky,this.clyde=new Clyde,Jeu.ELEMENT.addEventListener("OutFromHome",this.ghostGotOut.bind(this),!1),Jeu.ELEMENT.addEventListener("InkyCanGo",this.inkyCanGo.bind(this),!1),Jeu.ELEMENT.addEventListener("ClydeCanGo",this.clydeCanGo.bind(this),!1),Jeu.ELEMENT.addEventListener("GhostEaten",this.ghostEaten.bind(this),!1)}return t.prototype.setCollideFunction=function(t){return this.pinky.setCollideFunction(t),this.blinky.setCollideFunction(t),this.inky.setCollideFunction(t),this.clyde.setCollideFunction(t),this},t.prototype.init=function(){return this.waveNumber=1,this.mode=Modes.Scatter,this.areFrightened=!1,this.pinky.init(),this.blinky.init(),this.inky.init(),this.clyde.init(),this.frames=0,this.frightenedFrames=0,this.numberEaten=0,this.changeMode(this.mode),this.pinky.getOutFromHome(),this},t.prototype.moveGhosts=function(t){this.areFrightened?this.frightenedFrames++:this.frames++;var e=this.areFrightened?Modes.Frightened:this.mode;switch(e){case Modes.Chase:this.frames>this.chaseInterval&&this.waveNumber<4&&(this.changeMode(Modes.Scatter),this.waveNumber++,this.waveNumber>2&&(this.scatterInterval=300),this.frames=0);break;case Modes.Scatter:this.frames>this.scatterInterval&&(this.changeMode(Modes.Chase),this.frames=0);break;case Modes.Frightened:this.frightenedFrames>this.frightenedInterval?(this.areFrightened=!1,this.numberEaten=0,this.changeAlternativeMode(null)):this.frightenedFrames>this.frightenedInterval-120&&this.flashGhosts()}return this.pinky.move(t),this.blinky.move(t),this.inky.move(t,this.blinky.getCoordinates()),this.clyde.move(t),this},t.prototype.animateGhosts=function(){return this.pinky.animate(),this.blinky.animate(),this.inky.animate(),this.clyde.animate(),this},t.prototype.changeMode=function(t){return this.mode=t,this.pinky.changeMode(this.mode),this.blinky.changeMode(this.mode),this.inky.changeMode(this.mode),this.clyde.changeMode(this.mode),this},t.prototype.changeAlternativeMode=function(t){return this.pinky.changeAlternativeMode(t),this.blinky.changeAlternativeMode(t),this.inky.changeAlternativeMode(t),this.clyde.changeAlternativeMode(t),this},t.prototype.flashGhosts=function(t){return void 0===t&&(t=!0),this.pinky.flash(t),this.blinky.flash(t),this.inky.flash(t),this.clyde.flash(t),this},t.prototype.getGhosts=function(){return[this.pinky,this.blinky,this.inky,this.clyde]},t.prototype.ghostGotOut=function(t){return t.detail.changeMode(this.mode),this},t.prototype.inkyCanGo=function(){return this.inky.getOutFromHome(),this},t.prototype.clydeCanGo=function(){return this.clyde.getOutFromHome(),this},t.prototype.goToFrightenedMode=function(){return this.frightenedFrames=0,this.changeAlternativeMode(Modes.Frightened),this.areFrightened=!0,this.flashGhosts(!1),this},t.prototype.ghostEaten=function(){this.numberEaten++;var t=new CustomEvent("UpdateScoreAfterGhostEaten",{detail:this.numberEaten});return Jeu.ELEMENT.dispatchEvent(t),this},t.INKY_DOT_TO_GO=30,t}(),Score=function(){function t(){}return t.prototype.init=function(){return this.score=0,this},t.prototype.toString=function(){return"Score : "+this.score},t.prototype.update=function(t){return t.getPacDot()instanceof PacDot&&(this.score+=t.getPacDot().getScoreValue()),this},t.prototype.updateWithGhost=function(t){switch(t){case 1:this.score+=200;break;case 2:this.score+=400;break;case 3:this.score+=800;break;case 4:this.score+=1600}return this},t}(),Jeu=function(){function t(){this.frames=0,this.playing=!1,this.addListeners(),this.canvas=new Canvas(document.querySelector("canvas")),this.levelManager=new LevelManager,this.fruitsManager=new FruitsManager,this.ghostsManager=new GhostsManager,this.score=new Score,this.pacman=new Pacman}return t.prototype.init=function(){this.canvas.clear(),this.levelManager.init(),this.levelManager.draw(this.canvas),this.ghostsManager.setCollideFunction(this.checkCollision.bind(this)),this.ghostsManager.init(),this.score.init(),this.drawTop(),this.pacman.setCollideFunction(this.checkCollision.bind(this)),this.pacman.init(),this.pacmanEaten=!1,this.pacman.draw();var e=this.pacman.getCoordinates(),i=(Tile.TILE_WIDTH-Pacman.SIZE.w)/2;return this.canvas.getContext().drawImage(this.pacman.getCanvasElem(),e.x+i,e.y+i+t.TOP_HEIGHT),this.powerPelletTiles=this.levelManager.getPowerPellet(),this.fruitsManager.init(),this},t.prototype.addListeners=function(){return t.ELEMENT.addEventListener("PacDotEatenProcessed",this.onPacDotEaten.bind(this),!1),t.ELEMENT.addEventListener("LevelFinished",this.onLevelFinished.bind(this),!1),t.ELEMENT.addEventListener("NewFruit",this.onNewFruit.bind(this),!1),t.ELEMENT.addEventListener("RemoveFruit",this.onRemoveFruit.bind(this),!1),t.ELEMENT.addEventListener("PacmanEaten",this.onPacmanEaten.bind(this),!1),t.ELEMENT.addEventListener("PacmanDied",this.onPacmanDead.bind(this),!1),t.ELEMENT.addEventListener("UpdateScoreAfterGhostEaten",this.onGhostEaten.bind(this),!1),document.querySelector(".jouer").addEventListener("click",this.play.bind(this),!1),window.addEventListener("keydown",this.onKeyDown.bind(this),!1),this},t.prototype.play=function(){return document.querySelector(".jouer").style.display="none",this.playing=!0,requestAnimFrame(this.draw.bind(this)),this},t.prototype.draw=function(){var e=this.pacmanEaten?t.EATEN_INTERVAL:t.INTERVAL;return null!=this.canvas&&this.frames>=e&&(this.pacmanEaten?(this.clearAll(),this.animatePacman()):(this.clearAll(),this.onNewFruit(null),this.flashPowerPellet(),this.drawEscapeDoor(),this.animatePacman(),this.animateGhosts(),this.drawScore(),this.fruitsManager.onRequestAnimFrame()),this.frames=0),this.playing===!0&&requestAnimFrame(this.draw.bind(this)),this.frames++,this},t.prototype.clearAll=function(){var e=this.canvas.getContext(),i=(Tile.TILE_WIDTH-Ghost.SIZE.w)/2,n=(Tile.TILE_WIDTH-Ghost.SIZE.w)/2,o=this.pacman.getCoordinates();e.clearRect(o.x+i,o.y+i+t.TOP_HEIGHT,Pacman.SIZE.w,Pacman.SIZE.h);for(var s=this.ghostsManager.getGhosts(),r=0,a=s.length;r<a;++r){var h=s[r];e.clearRect(h.getCoordinates().x+n,h.getCoordinates().y+n+t.TOP_HEIGHT,Ghost.SIZE.w,Ghost.SIZE.h),this.drawCurrentPacDot(TileFunctions.getTileCoordinates({x:h.getCoordinates().x+Tile.TILE_WIDTH/2,y:h.getCoordinates().y+Tile.TILE_WIDTH/2}),!0)}return this.drawCurrentPacDot(this.pacman.getPreviousTileCoords(),!0),this},t.prototype.animatePacman=function(){var e=this.pacman,i=e.getCoordinates(),n=(Tile.TILE_WIDTH-Pacman.SIZE.w)/2,o=this.canvas.getContext();return this.pacmanEaten?this.pacman.die():(e.move(),e.animate(),this.drawCurrentPacDot(e.getPreviousTileCoords())),this.playing===!0&&o.drawImage(e.getCanvasElem(),i.x+n,i.y+n+t.TOP_HEIGHT),Tunnel.checkEntry(e,o,n),this},t.prototype.animateGhosts=function(){var e=this.canvas.getContext(),i=(Tile.TILE_WIDTH-Ghost.SIZE.w)/2,n=this.ghostsManager.getGhosts(),o=this.pacman.getCoordinates();this.ghostsManager.moveGhosts({x:o.x+Tile.TILE_WIDTH/2,y:o.y+Tile.TILE_WIDTH/2,direction:this.pacman.getDirection()}),this.ghostsManager.animateGhosts();for(var s=0,r=n.length;s<r;++s){var a=n[s];this.drawCurrentPacDot(TileFunctions.getTileCoordinates({x:a.getCoordinates().x+Tile.TILE_WIDTH/2,y:a.getCoordinates().y+Tile.TILE_WIDTH/2})),e.drawImage(a.getCanvas().getElement(),a.getCoordinates().x+i,a.getCoordinates().y+i+t.TOP_HEIGHT),Tunnel.checkEntry(a,e,i)}return this},t.prototype.drawCurrentPacDot=function(e,i){void 0===i&&(i=!1);var n=5,o=this.levelManager.getTiles(),s=void 0!=o[e.y]?o[e.y][e.x]:null;return null!=s&&s.hasPacDot()&&(s.getPacDot()instanceof Fruit||s.getPacDot()instanceof PowerPellet||(i&&this.canvas.getContext().clearRect(e.x*Tile.TILE_WIDTH+n,e.y*Tile.TILE_WIDTH+n+t.TOP_HEIGHT,30,30),this.levelManager.drawPacDot(this.canvas,s))),this},t.prototype.drawTop=function(){var e=this.canvas.getContext();return e.beginPath(),e.strokeStyle="#012EB6",e.lineWidth=4,e.moveTo(0,t.TOP_HEIGHT),e.lineTo(this.canvas.getElement().width,t.TOP_HEIGHT),e.lineTo(this.canvas.getElement().width,this.canvas.getElement().height),e.lineTo(0,this.canvas.getElement().height),e.lineTo(0,t.TOP_HEIGHT),e.stroke(),e.globalCompositeOperation="destination-out",e.lineWidth=2,e.stroke(),e.globalCompositeOperation="source-over",e.closePath(),e.clearRect(15*Tile.TILE_WIDTH-5,11*Tile.TILE_WIDTH+2,Tile.TILE_WIDTH,Tile.TILE_WIDTH-4),e.clearRect(-1*Tile.TILE_WIDTH+5,11*Tile.TILE_WIDTH+2,Tile.TILE_WIDTH,Tile.TILE_WIDTH-4),e.fillStyle="white",e.font="16px Arial",e.fillText(this.score.toString(),10,t.TOP_HEIGHT/2+5),e.textAlign="center",e.fillText("Pacman",this.canvas.getElement().width/2,t.TOP_HEIGHT/2+5),e.textAlign="right",e.fillText("Niveau 1",this.canvas.getElement().width-10,t.TOP_HEIGHT/2+5),this},t.prototype.drawScore=function(){var e=this.canvas.getContext();return e.clearRect(0,0,200,t.TOP_HEIGHT-5),e.textAlign="left",e.fillText(this.score.toString(),10,t.TOP_HEIGHT/2+5),this},t.prototype.drawEscapeDoor=function(){var t=this.canvas.getContext();return t.clearRect(7*Tile.TILE_WIDTH,10*Tile.TILE_WIDTH-5,Tile.TILE_WIDTH,Tile.TILE_WIDTH),t.beginPath(),t.moveTo(7*Tile.TILE_WIDTH,10*Tile.TILE_WIDTH),t.lineTo(8*Tile.TILE_WIDTH,10*Tile.TILE_WIDTH),t.strokeStyle="white",t.lineWidth=1,t.stroke(),t.closePath(),this},t.prototype.flashPowerPellet=function(){for(var e=new Date,i=this.canvas.getContext(),n=10,o=0,s=this.powerPelletTiles.length;o<s;++o)i.clearRect(this.powerPelletTiles[o].getCoordinates().x*Tile.TILE_WIDTH+n,this.powerPelletTiles[o].getCoordinates().y*Tile.TILE_WIDTH+n+t.TOP_HEIGHT,Tile.TILE_WIDTH/2,Tile.TILE_WIDTH/2);if(e.getMilliseconds()>=500)for(var o=0,s=this.powerPelletTiles.length;o<s;++o)this.levelManager.drawPacDot(this.canvas,this.powerPelletTiles[o]);return this},t.prototype.checkCollision=function(t,e){var i=this.levelManager.getTiles();return void 0==i[e]||void 0===i[e][t]||i[e][t].isAWall()},t.prototype.onPacDotEaten=function(t){var e=t.detail,i=this.levelManager.getTiles(),n=i[e.y][e.x];return void 0!=n&&(this.score.update(n),n.getPacDot()instanceof Fruit?this.fruitsManager.init():n.getPacDot()instanceof PowerPellet&&this.ghostsManager.goToFrightenedMode(),n.setPacDot(null)),this},t.prototype.onLevelFinished=function(){return console.log("Todo : Niveau terminé"),this},t.prototype.onNewFruit=function(e){var i=this.levelManager.getTiles(),n=i[Pacman.BASE_Y][Pacman.BASE_X],o=null===e?n.getPacDot():e.detail;if(null!==e||null!==o){this.onRemoveFruit(!1);var s=Fruit.WIDTH,r=(Tile.TILE_WIDTH-s)/2,a=0;n.setPacDot(o),o instanceof Strawberry?a=1:o instanceof Orange?a=2:o instanceof Apple?a=3:o instanceof Melon?a=4:o instanceof Galaxian?a=5:o instanceof Bell?a=6:o instanceof Key&&(a=7);var h=document.querySelector("img");this.canvas.getContext().drawImage(h,a*s,0,s,s,n.getCoordinates().x*Tile.TILE_WIDTH+r,n.getCoordinates().y*Tile.TILE_WIDTH+r+t.TOP_HEIGHT,s,s)}return this},t.prototype.onRemoveFruit=function(e){void 0===e&&(e=!0);var i=Fruit.WIDTH,n=(Tile.TILE_WIDTH-i)/2;if(this.canvas.getContext().clearRect(Pacman.BASE_X*Tile.TILE_WIDTH+n,Pacman.BASE_Y*Tile.TILE_WIDTH+n+t.TOP_HEIGHT,i,i),e!==!1){var o=this.levelManager.getTiles(),s=o[Pacman.BASE_Y][Pacman.BASE_X];s.setPacDot(null)}return this},t.prototype.onPacmanEaten=function(){return this.pacmanEaten=!0,this},t.prototype.onPacmanDead=function(){return document.querySelector(".jouer").style.display="block",this.playing=!1,this.init(),this},t.prototype.onGhostEaten=function(t){return this.score.updateWithGhost(t.detail),this},t.prototype.onKeyDown=function(t){return this.playing||32!=t.keyCode&&13!=t.keyCode||this.play(),this},t.INTERVAL=1,t.EATEN_INTERVAL=10,t.TOP_HEIGHT=40,t.ELEMENT=document.createElement("DIV"),t}(),Tile=function(){function t(){this.wall=!1,this.pacDot=null,this.coordinates={x:0,y:0},this.borderLeft=!0,this.borderRight=!0,this.borderTop=!0,this.borderBottom=!0}return t.prototype.isAWall=function(t){return void 0===t&&(t=null),null!==t&&(this.wall=t),this.wall},t.prototype.hasBorderLeft=function(t){return void 0===t&&(t=null),null!==t&&(this.borderLeft=t),this.borderLeft},t.prototype.hasBorderRight=function(t){return void 0===t&&(t=null),null!==t&&(this.borderRight=t),this.borderRight},t.prototype.hasBorderTop=function(t){return void 0===t&&(t=null),null!==t&&(this.borderTop=t),this.borderTop},t.prototype.hasBorderBottom=function(t){return void 0===t&&(t=null),null!==t&&(this.borderBottom=t),this.borderBottom},t.prototype.setCoordinates=function(t,e){this.coordinates.x=t,this.coordinates.y=e},t.prototype.getCoordinates=function(){return this.coordinates},t.prototype.setPacDot=function(t){return this.pacDot=t,this},t.prototype.hasPowerPellet=function(){return null!=this.pacDot&&this.pacDot instanceof PowerPellet},t.prototype.hasPacDot=function(){return null!=this.pacDot},t.prototype.getPacDot=function(){return this.pacDot},t.TILE_WIDTH=40,t}(),Pacman=function(){function t(){window.addEventListener("keydown",this.rotate.bind(this),!1)}return t.prototype.setCollideFunction=function(t){return this.checkCollision=t,this},t.prototype.setX=function(t){return this.coordinates.x=t,this},t.prototype.getCoordinates=function(){return this.coordinates},t.prototype.getCanvasElem=function(){return this.canvas.getElement()},t.prototype.getDirection=function(){return this.direction},t.prototype.init=function(){return this.coordinates={x:7*Tile.TILE_WIDTH,y:10*Tile.TILE_WIDTH},this.currentStep=0,this.stepNumber=12,this.stepPx=2,this.angle=0,this.canvas=new Canvas,this.canvas.setSize(t.SIZE.w,t.SIZE.h),this.direction=Directions.Right,this.nextDirection=this.direction,this},t.prototype.rotate=function(t){var e=t.keyCode;switch(e){case 37:t.preventDefault(),this.nextDirection=Directions.Left;break;case 38:t.preventDefault(),this.nextDirection=Directions.Up;break;case 39:t.preventDefault(),this.nextDirection=Directions.Right;break;case 40:t.preventDefault(),this.nextDirection=Directions.Down}return this},t.prototype.animate=function(){return this.currentStep++,this.currentStep%this.stepNumber==0&&(this.currentStep=0),this.draw(),this},t.prototype.move=function(){var t=Tile.TILE_WIDTH,e=!1,i=!1,n=this.coordinates.x,o=this.coordinates.y;if(this.coordinates.x%t==0&&this.coordinates.y%t==0){var s=this.getNextTileCoords(this.nextDirection),r=this.getNextTileCoords(this.direction);e=this.checkCollision(s.x,s.y),i=this.checkCollision(r.x,r.y),this.direction==Directions.Right&&15==r.x&&10==r.y&&(i=!1),this.direction==Directions.Left&&r.x==-1&&10==r.y&&(i=!1),e||(this.direction=this.nextDirection)}else(this.direction==Directions.Left&&this.nextDirection==Directions.Right||this.direction==Directions.Right&&this.nextDirection==Directions.Left||this.direction==Directions.Up&&this.nextDirection==Directions.Down||this.direction==Directions.Down&&this.nextDirection==Directions.Up)&&(this.direction=this.nextDirection);var a;switch(this.direction){case Directions.Left:a=100-this.coordinates.x%t*100/t,n-=this.stepPx,this.angle=180;break;case Directions.Right:a=this.coordinates.x<0?(this.coordinates.x+Tile.TILE_WIDTH)%t*100/t:this.coordinates.x%t*100/t,n+=this.stepPx,this.angle=0;break;case Directions.Up:a=100-this.coordinates.y%t*100/t,o-=this.stepPx,this.angle=270;break;case Directions.Down:a=this.coordinates.y%t*100/t,o+=this.stepPx,this.angle=90}if(e&&i||(this.coordinates.x=n,this.coordinates.y=o),75==a){var h=this.getCurrentTileCoords(),c=new CustomEvent("PacDotEaten",{detail:h});Jeu.ELEMENT.dispatchEvent(c)}return this},t.prototype.draw=function(){var e=this.canvas.getContext(),i=t.SIZE;Tile.TILE_WIDTH;this.canvas.clear(),e.save(),e.translate(i.w/2,i.h/2),e.rotate(this.angle*Math.PI/180),e.translate(-i.w/2,-i.h/2),e.fillStyle="#FFFF00";var n=.25*this.currentStep/(this.stepNumber-1),o=1-n,s=(o+1)*Math.PI,r=n*Math.PI;if(s<Math.PI){s=0,r=0;var a=new Event("PacmanDied");Jeu.ELEMENT.dispatchEvent(a)}return e.beginPath(),e.arc(i.w/2,i.h/2,i.w/2,s,r,!0),e.lineTo(i.w/2,i.h/2),e.fill(),e.restore(),this},t.prototype.getNextTileCoords=function(t){var e=this.getCurrentTileCoords();switch(t){case Directions.Left:e.x--;break;case Directions.Right:e.x++;break;case Directions.Up:e.y--;break;case Directions.Down:e.y++}return e},t.prototype.getCurrentTileCoords=function(){return TileFunctions.getTileCoordinates({x:this.coordinates.x+t.SIZE.w/2,y:this.coordinates.y+t.SIZE.h/2})},t.prototype.getPreviousTileCoords=function(){var t=this.getCurrentTileCoords();switch(this.direction){case Directions.Left:t.x++;break;case Directions.Up:t.y++}return 15==t.x&&(t.x=0),t},t.prototype.die=function(){return this.currentStep+=5,this.draw(),this},t.BASE_X=7,t.BASE_Y=10,t.SIZE={w:24,h:24},t}(),Level=function(){function t(){}return t.prototype.init=function(){this.tiles=new Array(20);for(var t=0,e=this.tiles.length;t<e;++t){this.tiles[t]=new Array(15);for(var i=0,n=this.tiles[t].length;i<n;++i)this.tiles[t][i]=new Tile,this.tiles[t][i].setCoordinates(i,t)}var o=[[0,7],[1,1],[1,2],[1,4],[1,5],[1,7],[1,9],[1,10],[1,12],[1,13],[3,1],[3,2],[3,3],[3,4],[3,5],[3,7],[3,9],[3,10],[3,11],[3,12],[3,13],[4,5],[4,7],[4,9],[5,1],[5,3],[5,5],[5,7],[5,9],[5,11],[5,13],[6,1],[6,13],[7,1],[7,2],[7,3],[7,4],[7,5],[7,7],[7,9],[7,10],[7,11],[7,12],[7,13],[9,0],[9,1],[9,2],[9,3],[9,4],[9,10],[9,11],[9,12],[9,13],[9,14],[11,0],[11,1],[11,2],[11,3],[11,5],[11,6],[11,7],[11,8],[11,9],[11,11],[11,12],[11,13],[11,14],[12,3],[12,7],[12,11],[13,1],[13,3],[13,5],[13,7],[13,9],[13,11],[13,13],[14,3],[14,5],[14,7],[14,9],[14,11],[15,1],[15,5],[15,9],[15,13],[16,1],[16,2],[16,3],[16,4],[16,5],[16,7],[16,9],[16,10],[16,11],[16,12],[16,13],[17,7],[18,1],[18,2],[18,3],[18,4],[18,5],[18,6],[18,7],[18,8],[18,9],[18,10],[18,11],[18,12],[18,13]];for(o.push([9,6]),o.push([9,7]),o.push([9,8]),t=0,e=o.length;t<e;++t)this.tiles[o[t][0]][o[t][1]].isAWall(!0);for(t=0,e=this.tiles.length;t<e;++t)for(i=0,n=this.tiles[t].length;i<n;++i)this.tiles[t][i].isAWall()||this.tiles[t][i].setPacDot(new PacDot);return this.tiles[2][1].setPacDot(new PowerPellet),this.tiles[2][13].setPacDot(new PowerPellet),this.tiles[12][2].setPacDot(new PowerPellet),this.tiles[12][12].setPacDot(new PowerPellet),this.tiles[Pacman.BASE_Y][Pacman.BASE_X].setPacDot(null),this},t.prototype.get=function(){return this.tiles},t}(),LevelManager=function(){function t(){this.level=new Level,this.pacDotNumber=0,Jeu.ELEMENT.addEventListener("PacDotEaten",this.pacDotEaten.bind(this),!1)}return t.prototype.init=function(){return this.level.init(),
this},t.prototype.draw=function(t){var e=this.getTiles();this.pacDotNumber=0;for(var i=0,n=e.length;i<n;++i)for(var o=e[i],s=0,r=o.length;s<r;++s){var a=o[s],h=o[s-1]||null,c=o[s+1]||null,l=null!=e[i-1]?e[i-1][s]:null,u=null!=e[i+1]?e[i+1][s]:null;a.hasBorderLeft(null!=h&&a.isAWall()&&!h.isAWall()),a.hasBorderRight(null!=c&&a.isAWall()&&!c.isAWall()),a.hasBorderTop(null!=l&&a.isAWall()&&!l.isAWall()),a.hasBorderBottom(null!=u&&a.isAWall()&&!u.isAWall()),this.drawTile(t,a),a.hasPacDot()&&(this.drawPacDot(t,a),this.pacDotNumber++)}return this.pacDotNumberTotal=this.pacDotNumber,this},t.prototype.drawTile=function(t,e){var i=t.getContext();i.beginPath(),i.strokeStyle="#012EB6",i.lineWidth=4;var n=Jeu.TOP_HEIGHT,o=e.getCoordinates();return e.hasBorderLeft()&&(i.moveTo(o.x*Tile.TILE_WIDTH,o.y*Tile.TILE_WIDTH+n),i.lineTo(o.x*Tile.TILE_WIDTH,(o.y+1)*Tile.TILE_WIDTH+n)),e.hasBorderRight()&&(i.moveTo((o.x+1)*Tile.TILE_WIDTH,o.y*Tile.TILE_WIDTH+n),i.lineTo((o.x+1)*Tile.TILE_WIDTH,(o.y+1)*Tile.TILE_WIDTH+n)),e.hasBorderTop()&&(i.moveTo(o.x*Tile.TILE_WIDTH,o.y*Tile.TILE_WIDTH+n),i.lineTo((o.x+1)*Tile.TILE_WIDTH,o.y*Tile.TILE_WIDTH+n)),e.hasBorderBottom()&&(i.moveTo(o.x*Tile.TILE_WIDTH,(o.y+1)*Tile.TILE_WIDTH+n),i.lineTo((o.x+1)*Tile.TILE_WIDTH,(o.y+1)*Tile.TILE_WIDTH+n)),i.stroke(),i.globalCompositeOperation="destination-out",i.lineWidth=2,i.stroke(),i.globalCompositeOperation="source-over",i.closePath(),this},t.prototype.drawPacDot=function(t,e){if(e.hasPacDot()){var i=t.getContext(),n=e.getCoordinates(),o=e.getPacDot()instanceof PowerPellet?6:3,s=Tile.TILE_WIDTH/2;i.beginPath(),i.arc(n.x*Tile.TILE_WIDTH+s,n.y*Tile.TILE_WIDTH+s+Jeu.TOP_HEIGHT,o,0,2*Math.PI,!1),i.fillStyle="white",i.strokeStyle="white",i.lineWidth=0,i.fill(),i.closePath()}return this},t.prototype.getTiles=function(){return this.level.get()},t.prototype.pacDotEaten=function(t){var e=t.detail,i=this.getTiles(),n=i[e.y][e.x];if(void 0!=n&&n.hasPacDot()&&!(n.getPacDot()instanceof Fruit)){if(this.pacDotNumber--,this.pacDotNumberTotal-this.pacDotNumber==GhostsManager.INKY_DOT_TO_GO){var o=new CustomEvent("InkyCanGo");Jeu.ELEMENT.dispatchEvent(o)}if(this.pacDotNumberTotal-this.pacDotNumber==Math.round(this.pacDotNumberTotal/3)){var o=new CustomEvent("ClydeCanGo");Jeu.ELEMENT.dispatchEvent(o)}}var o=new CustomEvent("PacDotEatenProcessed",{detail:t.detail});if(Jeu.ELEMENT.dispatchEvent(o),this.pacDotNumber<=0){var o=new CustomEvent("LevelFinished");Jeu.ELEMENT.dispatchEvent(o)}return this},t.prototype.getPowerPellet=function(){for(var t=this.getTiles(),e=[],i=0,n=t.length;i<n;++i)for(var o=0,s=t[i].length;o<s;++o)t[i][o].hasPowerPellet()&&e.push(t[i][o]);return e},t}(),requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60,(new Date).getTime())}}();(new Jeu).init();var PathFinder=function(){function t(){this.nextTile=null}return t.prototype.getDistance=function(){return this.distance},t.prototype.getNextTile=function(){return this.nextTile},t.prototype.findPath=function(t,e,i,n){var o=[{x:t.x,y:t.y,i:0,parent:null}],s=TileFunctions.getAdjacentTiles(t);Functions.shuffle(s);for(var r=0;r<s.length;++r){var a=i(s[r].x,s[r].y);if(!a&&!n(t,s[r])){if(s[r].x==e.x&&s[r].y==e.y&&!n(t,s[r])){this.distance=1,this.nextTile=s[r],o=[];break}o.push({x:s[r].x,y:s[r].y,i:1,parent:s[r]})}}for(r=1;r<o.length;++r){for(var h=TileFunctions.getAdjacentTiles({x:o[r].x,y:o[r].y}),c=0;c<4;++c){for(var a=i(h[c].x,h[c].y),l=!1,u=0,d=o.length;u<d;++u)if(o[u].x==h[c].x&&o[u].y==h[c].y&&o[u].i<=r&&(null==o[u].parent||o[u].parent.x==o[r].parent.x&&o[u].parent.y==o[r].parent.y)){l=!0;break}if(a||l||o.push({x:h[c].x,y:h[c].y,i:o[r].i+1,parent:o[r].parent}),h[c].x==e.x&&h[c].y==e.y&&r>2){this.distance=o[r].i,this.nextTile=o[r].parent;break}}if(null!=this.nextTile)break}return this},t}(),TileFunctions=function(){function t(){}return t.getAdjacentTiles=function(t){return[{x:t.x-1,y:t.y},{x:t.x+1,y:t.y},{x:t.x,y:t.y-1},{x:t.x,y:t.y+1}]},t.getTileCoordinates=function(t){var e=t.x%Tile.TILE_WIDTH,i=t.y%Tile.TILE_WIDTH;return{x:(t.x-e)/Tile.TILE_WIDTH,y:(t.y-i)/Tile.TILE_WIDTH}},t}(),Tunnel=function(){function t(){}return t.checkEntry=function(t,e,i){var n=t instanceof Ghost,o=t.getCanvasElem(),s=t.getCoordinates(),r=s.x>=14*Tile.TILE_WIDTH&&s.y==10*Tile.TILE_WIDTH,a=s.x<=0&&s.y==10*Tile.TILE_WIDTH;if(a||r){var h=r?s.x-e.canvas.width:s.x+e.canvas.width;r?e.clearRect(h,s.y+i+Jeu.TOP_HEIGHT,Pacman.SIZE.w+i+2,Tile.TILE_WIDTH-2*i):e.clearRect(h+i-2,s.y+i+Jeu.TOP_HEIGHT,Pacman.SIZE.w+i,Tile.TILE_WIDTH-2*i),e.drawImage(o,h+i,s.y+i+Jeu.TOP_HEIGHT),(r&&h>=-Tile.TILE_WIDTH/2||a&&h<=14*Tile.TILE_WIDTH+Tile.TILE_WIDTH/2)&&t.setX(h),n&&(r&&h<=-Tile.TILE_WIDTH||a&&h>=15*Tile.TILE_WIDTH?t.speedUp():t.slow())}return this},t}();